<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>CppCMS: json_rpc_chat/chat.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">CppCMS
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="index.html">CppCMS - C++ Web Development Framework</a>      </li>
      <li class="navelem"><a class="el" href="examples_page.html">Examples</a>      </li>
      <li class="navelem"><a class="el" href="ex_json_rpc_chat.html">Implementing chat using asynchronous JSON RPC calls</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">json_rpc_chat/chat.cpp Source File </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="fragment"><pre class="fragment">
<span class="comment">//                                                                             </span>
<span class="comment">//  Copyright (C) 2008-2012  Artyom Beilis (Tonkikh) &lt;artyomtnk@yahoo.com&gt;     </span>
<span class="comment">//                                                                             </span>
<span class="comment">//  See accompanying file COPYING.TXT file for licensing details.</span>
<span class="comment">//</span>
<span class="comment"></span><span class="preprocessor">#include &lt;cppcms/application.h&gt;</span>
<span class="preprocessor">#include &lt;cppcms/url_dispatcher.h&gt;</span>
<span class="preprocessor">#include &lt;cppcms/applications_pool.h&gt;</span>
<span class="preprocessor">#include &lt;cppcms/service.h&gt;</span>
<span class="preprocessor">#include &lt;cppcms/http_response.h&gt;</span>
<span class="preprocessor">#include &lt;cppcms/http_request.h&gt;</span>
<span class="preprocessor">#include &lt;cppcms/http_context.h&gt;</span>
<span class="preprocessor">#include &lt;cppcms/rpc_json.h&gt;</span>
<span class="preprocessor">#include &lt;cppcms/json.h&gt;</span>
<span class="preprocessor">#include &lt;booster/intrusive_ptr.h&gt;</span>
<span class="preprocessor">#include &lt;booster/aio/deadline_timer.h&gt;</span>
<span class="preprocessor">#include &lt;booster/system_error.h&gt;</span>

<span class="preprocessor">#include &lt;set&gt;</span>

<span class="preprocessor">#include &lt;boost/bind.hpp&gt;</span>
<span class="keyword">using</span> boost::bind;


<span class="keyword">class </span>chat : <span class="keyword">public</span> cppcms::rpc::json_rpc_server {
<span class="keyword">public</span>:
    chat(<a class="code" href="classcppcms_1_1service.html" title="This class represent the central event loop of the CppCMS applications.">cppcms::service</a> &amp;srv) : 
        cppcms::rpc::json_rpc_server(srv),
        timer_(srv.get_io_service())
    {
        <span class="comment">// Our main methods</span>
        bind(<span class="stringliteral">&quot;post&quot;</span>,cppcms::rpc::json_method(&amp;chat::post,<span class="keyword">this</span>),notification_role);
        bind(<span class="stringliteral">&quot;get&quot;</span>,cppcms::rpc::json_method(&amp;chat::get,<span class="keyword">this</span>),method_role);
        
        <span class="comment">// Add timeouts to the system</span>
        last_wake_ = <a class="code" href="group__manipulators.html#ga7ef04454ad2736a51c55c3cd0270d80c">time</a>(0);
        on_timer(<a class="code" href="classbooster_1_1system_1_1error__code.html" title="The lightweight object that carries a error code information and its category.">booster::system::error_code</a>());
    }

    <span class="comment">// Handle new message call</span>
    <span class="keywordtype">void</span> post(std::string <span class="keyword">const</span> &amp;author,std::string <span class="keyword">const</span> &amp;<a class="code" href="group__message.html#gaf3f50828c78db8b38441f97a472e6725">message</a>)
    {
        <a class="code" href="classcppcms_1_1json_1_1value.html" title="This class is central representation of json objects.">cppcms::json::value</a> obj;
        obj[<span class="stringliteral">&quot;author&quot;</span>]=author;
        obj[<span class="stringliteral">&quot;message&quot;</span>]=<a class="code" href="group__message.html#gaf3f50828c78db8b38441f97a472e6725">message</a>;
        messages_.push_back(obj);
        broadcast(messages_.size()-1);
    }

    <span class="keywordtype">void</span> on_timer(<a class="code" href="classbooster_1_1system_1_1error__code.html" title="The lightweight object that carries a error code information and its category.">booster::system::error_code</a> <span class="keyword">const</span> &amp;e)
    {
        <span class="keywordflow">if</span>(e) <span class="keywordflow">return</span>; <span class="comment">// cancelation</span>

        <span class="comment">// check idle connections for more then 10 seconds</span>
        <span class="keywordflow">if</span>(<a class="code" href="group__manipulators.html#ga7ef04454ad2736a51c55c3cd0270d80c">time</a>(0) - last_wake_ &gt; 10) {
            broadcast(messages_.size());
        }
        <span class="comment">// restart timer</span>
        timer_.expires_from_now(<a class="code" href="classbooster_1_1ptime.html#a5056017d41a4ace5d5c1efd6dba6b265">booster::ptime::seconds</a>(1));
        timer_.async_wait(boost::bind(&amp;chat::on_timer,<a class="code" href="classbooster_1_1intrusive__ptr.html" title="intrusive_ptr is the class taken as-is from boost.">booster::intrusive_ptr&lt;chat&gt;</a>(<span class="keyword">this</span>),_1));
    }

    <span class="comment">// Handle request</span>
    <span class="keywordtype">void</span> <span class="keyword">get</span>(<span class="keywordtype">unsigned</span> from)
    {
        <span class="keywordflow">if</span>(from &lt; messages_.size()) {
            <span class="comment">// not long polling - return result now</span>
            return_result(make_response(from));
            <span class="keywordflow">return</span>;
        }
        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(from == messages_.size()) {
            <span class="comment">// Can&#39;t answer now</span>

            <span class="comment">// Add long polling request to the list</span>

            <a class="code" href="classbooster_1_1shared__ptr.html">booster::shared_ptr&lt;cppcms::rpc::json_call&gt;</a> call=release_call();
            waiters_.insert(call);

            <span class="comment">// set disconnect callback</span>
            call-&gt;<a class="code" href="classcppcms_1_1rpc_1_1json__call.html#a8ef7d2f3b159b76a4ce7ce87562427bd">context</a>().<a class="code" href="classcppcms_1_1http_1_1context.html#a0f6fe53deabd90fee0ced81a8df6404e">async_on_peer_reset</a>(
                boost::bind(
                    &amp;chat::remove_context,
                    <a class="code" href="classbooster_1_1intrusive__ptr.html" title="intrusive_ptr is the class taken as-is from boost.">booster::intrusive_ptr&lt;chat&gt;</a>(<span class="keyword">this</span>),
                    call));
        }
        <span class="keywordflow">else</span> {
            return_error(<span class="stringliteral">&quot;Invalid position&quot;</span>);
        }
    }

    <span class="comment">// handle client disconnect</span>
    <span class="keywordtype">void</span> remove_context(<a class="code" href="classbooster_1_1shared__ptr.html">booster::shared_ptr&lt;cppcms::rpc::json_call&gt;</a> call)
    {
        waiters_.erase(call);
    }

    <span class="keywordtype">void</span> broadcast(<span class="keywordtype">size_t</span> from)
    {
        <span class="comment">// update timeout</span>
        last_wake_ = <a class="code" href="group__manipulators.html#ga7ef04454ad2736a51c55c3cd0270d80c">time</a>(0);
        <span class="comment">// Prepare response</span>
        <a class="code" href="classcppcms_1_1json_1_1value.html" title="This class is central representation of json objects.">cppcms::json::value</a> response = make_response(from);
        <span class="comment">// Send it to everybody</span>
        <span class="keywordflow">for</span>(waiters_type::iterator waiter=waiters_.begin();waiter!=waiters_.end();++waiter) {
            <a class="code" href="classbooster_1_1shared__ptr.html">booster::shared_ptr&lt;cppcms::rpc::json_call&gt;</a> call = *waiter;
            call-&gt;<a class="code" href="classcppcms_1_1rpc_1_1json__call.html#a837bedb8818cc46e588ac7d868b17807">return_result</a>(response);
        }
        waiters_.clear();
    }

    <span class="comment">// Prepare response to the client</span>
    <a class="code" href="classcppcms_1_1json_1_1value.html" title="This class is central representation of json objects.">cppcms::json::value</a> make_response(<span class="keywordtype">size_t</span> n)
    {
        <a class="code" href="classcppcms_1_1json_1_1value.html" title="This class is central representation of json objects.">cppcms::json::value</a> v;

        <span class="comment">// Small optimization</span>
        v=<a class="code" href="namespacecppcms_1_1json.html#aefdab4e43ce88b19e1a73eecfe02d799" title="The json::array - std::vector of json::value&#39;s.">cppcms::json::array</a>();
        <a class="code" href="namespacecppcms_1_1json.html#aefdab4e43ce88b19e1a73eecfe02d799" title="The json::array - std::vector of json::value&#39;s.">cppcms::json::array</a> &amp;ar  = v.<a class="code" href="classcppcms_1_1json_1_1value.html#aa883e6ec2f9d8c4a11bd48c6a4d40025">array</a>();
        ar.reserve(messages_.size() - n);

        <span class="comment">// prepare all messages</span>
        <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i=n;i&lt;messages_.size();i++) {
            ar.push_back(messages_[i]);
        }
        <span class="keywordflow">return</span> v;
    }
<span class="keyword">private</span>:

    <span class="comment">// message store</span>
    std::vector&lt;cppcms::json::value&gt; messages_;

    <span class="comment">// long poll requests</span>
    <span class="keyword">typedef</span> std::set&lt;booster::shared_ptr&lt;cppcms::rpc::json_call&gt; &gt; waiters_type;
    waiters_type waiters_;

    <span class="comment">// timer for resetting idle requests</span>
    <a class="code" href="classbooster_1_1aio_1_1deadline__timer.html" title="A timer object.">booster::aio::deadline_timer</a> timer_;
    time_t last_wake_;
};


<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc,<span class="keywordtype">char</span> **argv)
{
    <span class="keywordflow">try</span> {
        <a class="code" href="classcppcms_1_1service.html" title="This class represent the central event loop of the CppCMS applications.">cppcms::service</a> service(argc,argv);
        <a class="code" href="classbooster_1_1intrusive__ptr.html" title="intrusive_ptr is the class taken as-is from boost.">booster::intrusive_ptr&lt;chat&gt;</a> c=<span class="keyword">new</span> chat(service);
        service.applications_pool().mount(c);
        service.run();
    }
    <span class="keywordflow">catch</span>(std::exception <span class="keyword">const</span> &amp;e) {
        std::cerr&lt;&lt;<span class="stringliteral">&quot;Catched exception: &quot;</span>&lt;&lt;e.what()&lt;&lt;std::endl;
        <span class="keywordflow">return</span> 1;
    }
    <span class="keywordflow">return</span> 0;
}
<span class="comment">// vim: tabstop=4 expandtab shiftwidth=4 softtabstop=4</span>
</pre></div> </div></div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated on Mon Jun 24 2013 15:32:31 for CppCMS by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
